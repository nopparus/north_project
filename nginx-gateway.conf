server {
    listen 80;
    server_name localhost;

    # Enable CORS
    add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS, PUT, DELETE';
    add_header Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization';

    resolver 127.0.0.11 valid=10s;

    # Root -> Menu App (No rewrite needed)
    location / {
        set $upstream_menu http://nexus-menu:80;
        proxy_pass $upstream_menu$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # App1 (Strip /app1/)
    location /app1/ {
        set $upstream_app1 http://nexus-app1:80;
        rewrite ^/app1/(.*) /$1 break;
        proxy_pass $upstream_app1$uri$is_args$args;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # App2 (Strip /app2/)
    location /app2/ {
        set $upstream_app2 http://nexus-app2:80;
        rewrite ^/app2/(.*) /$1 break;
        proxy_pass $upstream_app2$uri$is_args$args;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # App3 (Strip /app3/)
    location /app3/ {
        set $upstream_app3 http://nexus-app3:80;
        rewrite ^/app3/(.*) /$1 break;
        proxy_pass $upstream_app3$uri$is_args$args;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # App4 Frontend (Strip /app4/)
    location /app4/ {
        set $upstream_app4 http://nexus-app4:80;
        rewrite ^/app4/(.*) /$1 break;
        proxy_pass $upstream_app4$uri$is_args$args;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # App5 (Strip /app5/)
    location /app5/ {
        set $upstream_app5 http://nexus-app5:80;
        rewrite ^/app5/(.*) /$1 break;
        proxy_pass $upstream_app5$uri$is_args$args;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Main API Proxy (Pass full path)
    location /api/ {
        set $upstream_api http://nexus-main-api:3001;
        proxy_pass $upstream_api$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # App4 API Proxy (Pass full path)
    location /app4/api/ {
        set $upstream_app4_api http://nexus-app4-backend:3004;
        proxy_pass $upstream_app4_api$request_uri;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
