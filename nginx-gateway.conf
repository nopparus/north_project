server {
    listen 80;
    server_name localhost;

    # Enable CORS
    add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS, PUT, DELETE';
    add_header Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization';

    resolver 127.0.0.11 valid=10s;
    client_max_body_size 50M;

    # 0. Protocol Handling (Internal variable)
    set $proto $scheme;
    if ($http_x_forwarded_proto) {
        set $proto $http_x_forwarded_proto;
    }

    # 1. Redirect app URLs without trailing slash (Protocol-aware)
    location ~ ^/(app[1-6])$ {
        return 301 $proto://$http_host/$1/;
    }

    # 2. App1 - Serve static files directly
    location /app1/ {
        alias /usr/share/nginx/app1/;
        try_files $uri $uri/ /app1/index.html;
    }

    # 3. App2 - Serve static files directly
    location /app2/ {
        alias /usr/share/nginx/app2/;
        try_files $uri $uri/ /app2/index.html;
    }

    # 4. App3 - Serve static files directly
    location /app3/ {
        alias /usr/share/nginx/app3/;
        try_files $uri $uri/ /app3/index.html;
    }

    # 5. App4 - Serve static files directly (Frontend)
    location /app4/ {
        alias /usr/share/nginx/app4/;
        try_files $uri $uri/ /app4/index.html;
    }

    # 6. App5 - Serve static files directly
    location /app5/ {
        alias /usr/share/nginx/app5/;
        try_files $uri $uri/ /app5/index.html;
    }

    # 7. App6 - Serve static files directly
    location /app6/ {
        alias /usr/share/nginx/app6/;
        try_files $uri $uri/ /app6/index.html;
    }

    # 8. API Proxies
    location /api/pms/ {
        proxy_pass http://nexus-app5-backend:3000/api/pms/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $proto;
    }

    location /api/ {
        proxy_pass http://nexus-main-api:3001/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $proto;
    }

    location /app4/api/ {
        proxy_pass http://nexus-app4-backend:3004/app4/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $proto;
    }

    # 9. Main Portal (Catch-all) - Serve menu static files
    location / {
        root /usr/share/nginx/menu;
        try_files $uri $uri/ /index.html;
    }
}
